# Testing Guide - Empathic Proxy

## Prerequisites Check

Run the status checker:
```bash
./check-status.sh
```

All systems should show ✅ before proceeding.

## Step 1: Configure Slack App

### Option A: Using Manifest (Recommended)

1. Go to [api.slack.com/apps](https://api.slack.com/apps)
2. Click **"Create New App"** → **"From an app manifest"**
3. Select your workspace
4. Copy and paste the contents of `slack-manifest.json`
5. Review and create

### Option B: Manual Configuration

1. Create app at [api.slack.com/apps](https://api.slack.com/apps)
2. Configure each section manually (see README.md)

## Step 2: Get Slack Credentials

After creating/updating your app:

1. **Basic Information** → Copy **Signing Secret**
2. **OAuth & Permissions** → Copy **Client ID** and **Client Secret**
3. **Install App** → Install to workspace → Copy **Bot User OAuth Token** (xoxb-...)

## Step 3: Set Environment Variables

```bash
export SLACK_CLIENT_ID=your_client_id
export SLACK_CLIENT_SECRET=your_client_secret
export SLACK_SIGNING_SECRET=your_signing_secret
export LLM_PROVIDER=localai
```

## Step 4: Restart App with Credentials

```bash
# Stop current app (if running)
pkill -f "spring-boot:run"

# Start with environment variables
export SLACK_CLIENT_ID=your_client_id
export SLACK_CLIENT_SECRET=your_client_secret
export SLACK_SIGNING_SECRET=your_signing_secret
export LLM_PROVIDER=localai

mvn spring-boot:run
```

## Step 5: Setup ngrok (for Local Testing)

In a separate terminal:

```bash
ngrok http 8080
```

Copy the HTTPS URL (e.g., `https://abc123.ngrok.io`)

## Step 6: Update Slack App URLs

Update your Slack app settings with ngrok URL:

1. **Event Subscriptions**:
   - Request URL: `https://your-ngrok-url.ngrok.io/events`
   - Verify it shows ✅ verified

2. **Interactivity & Shortcuts**:
   - Request URL: `https://your-ngrok-url.ngrok.io/interactivity`

3. **OAuth & Permissions**:
   - Redirect URL: `https://your-ngrok-url.ngrok.io/oauth/callback`

## Step 7: Install App to Workspace

Visit: `https://your-ngrok-url.ngrok.io/oauth/install`

Or use the OAuth URL from your Slack app settings.

## Step 8: Test the Integration

### Test 1: Home Tab
1. Open Slack
2. Click on "Empathic Proxy" in the sidebar
3. Navigate to **Home** tab
4. Should see "Your Inbox" (may be empty initially)

### Test 2: App Mention
1. Go to any channel
2. Mention the app: `@Empathic Proxy Hello, can you help me with this?`
3. Wait a few seconds
4. Check the **Home** tab
5. Should see:
   - The mention in the inbox
   - An extracted action item
   - A suggested reply (generated by LLM)

### Test 3: Direct Message
1. Open a DM with the app
2. Send: `Hi, I need help with a project`
3. Check the **Home** tab
4. Should see the DM with LLM-generated action and reply

### Test 4: Composer
1. In the Home tab, click **"Reply"** on any inbox item
2. Modal should open with:
   - Draft text area (pre-filled with suggested reply)
   - Transform buttons (Professional, Casual, Short, Long)
3. Try transforming the draft
4. Click **"Post"** to send
5. Message should appear in the original channel/thread

### Test 5: Message Shortcut
1. Right-click on any message in Slack
2. Select **"Compose Reply"** from the menu
3. Composer modal should open
4. Draft and post a reply

## Step 9: Verify LLM Integration

Check that the local LLM is being used:

1. Send a test message to the app
2. Check the Home tab for the inbox item
3. The "Action" and "Suggested Reply" should be generated by Ollama
4. Check app logs for LLM API calls

## Troubleshooting

### Events not received
- Verify ngrok is running
- Check Event Subscriptions shows ✅ verified
- Review server logs: `tail -f /tmp/empathic-proxy.log`

### OAuth fails
- Verify redirect URL matches exactly
- Check client ID and secret are correct
- Review OAuth callback logs

### LLM not working
- Verify Ollama is running: `docker ps | grep ollama`
- Test Ollama directly: `curl -X POST http://localhost:11434/v1/chat/completions ...`
- Check `LLM_PROVIDER=localai` is set
- Review app logs for LLM errors

### Home tab empty
- Verify app is installed
- Check that events are being received
- Review database: `sqlite3 empathic_proxy.db "SELECT * FROM inbox_items;"`

### Composer not opening
- Check interactivity URL is correct
- Verify shortcut callback_id matches
- Review interactivity logs

## Success Criteria

✅ App installs successfully  
✅ Home tab displays inbox  
✅ Mentions create inbox items with LLM-generated actions/replies  
✅ DMs create inbox items  
✅ Composer opens and posts messages  
✅ Message shortcut works  
✅ LLM transformations work  

## Next Steps

Once everything is working:
1. Test with different message types
2. Try various LLM transformations
3. Review audit logs
4. Customize prompts in LLMService if needed

